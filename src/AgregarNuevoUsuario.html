<?php
     require_once("../Login/php/logInPreemptiveCheckup.php");
     session_start();
     logInPreemptiveCheckup();
?>

<html lang="en">
<head>
    <title>AgregarNuevoUsuario.html</title>

    <!--MetaArea-->
    <meta charset="utf-8"> <!--Caracteres Codificados-->
    <meta name="viewport" content="width=device-width, initial-scale=1"> <!--Para Dispositivos Moviles habilita touch-zoom etc-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--/MetaArea-->
    <!--CSS-->
    <link href="css/bootstrap.min.css" rel="stylesheet"><!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
    <link rel="icon" href="img/luxline1.ico" type="image/x-icon">

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!--/JS-->
    <!--Google+ api-->
    <script src="https://apis.google.com/js/api.js?onload=handleClientLoad"></script>
    <!--Google+ api-->
    <!--ApiLogIn-->
    <script>
        var ApiLogIn = function (btnSingIn, btnSignOut, msgContainer,phpLogin) {
            //var test = 10; private variable
            //var method = function(){} private method
            //this.test = 10; public variable
            //this.method = function(){} public method
            var self = this;
            var m_auth2 = null; // The Sign-In object.
            var m_btnSignIn = btnSingIn;
            var m_btnSignOut = btnSignOut;
            var m_message = msgContainer;
            var m_apiKey = 'accesssecurity-140019';
            var m_clientId = "1043488027097-f77grlc3h5cli90m6c0b4urra6jmcakn.apps.googleusercontent.com";
            var m_phpLogin = phpLogin;
            var m_stayAfterLogOut = false;
            this.m_getProfileInfoLogin = false;
            // Enter one or more authorization scopes. Refer to the documentation for
            // the API or https://developers.google.com/identity/protocols/googlescopes
            // for details.
            var m_scopes = 'profile https://www.googleapis.com/auth/userinfo.profile';
            var m_cookie_policy = 'single_host_origin';

            this.signIn = function () {
                m_auth2.signIn();
            }

            this.signIn_Thenable = function (fnc_onsuccess, fnc_onfailure) {
                m_auth2.signIn().then(fnc_onsuccess, fnc_onfailure);
            }

            this.signOut = function () {
                m_auth2.signOut();
            }

            this.getUserProfile = function () {
                var User = m_auth2.currentUser.get()
                var profile = User.getBasicProfile();
                //*****************googleUser**************
                return profile;
            }


            this.logOut = function (stay) {
                m_stayAfterLogOut = stay;
                var User = m_auth2.currentUser.get();
                var l_RO = User.getAuthResponse();
                var access_token = l_RO.access_token;

                var location = (parseInt(screen.availWidth) / 2) - 290;
                var revokeUrl = window.open('https://accounts.google.com/Logout', "Logout", "left=" + location + ",top=10 width=580,height=800");
                revokeUrl.focus();
                setTimeout(function () {
                    revokeUrl.close();
                }, 500);
            }

            var updateSigninStatus = function (isSignedIn) { //Callback function
                if (isSignedIn) {
                    if (self.m_getProfileInfoLogin === true) { //AgregarUsuario
                        var lo_profile = self.getUserProfile();
                        gd_btnGoContinuar.show();
                        gd_btnGoCancelar.show();
                        gd_cubitoWaitingAgregarUsuario.hide();
                        gd_contentContainerAgregarUsuario.show();
                        gd_footerAgregarUsuario.show();
                        gd_pAgregarUsuario.show();

                        gi_imgAgregarUsuario.show();
                        gi_imgAgregarUsuario.attr("src", lo_profile.getImageUrl());

                        gd_headerAgregarUsuario.html('<h3 id="i_headerAgregarUsuario" style="font-weight:bolder;">Información de Perfíl</h3>');
                        gd_pAgregarUsuario.html('<p>Nombre: '+ lo_profile.getName() +'</p><p>Correo: '+ lo_profile.getEmail() +'</p>');
                        gd_footerAgregarUsuario.text("Asegurese que la información anterior sea correcta");

                        m_stayAfterLogOut = false;
                        return;
                    }
                    //*****************googleUser**************
                    //A GoogleUser object represents one user account.
                    var User = m_auth2.currentUser.get()
                    var profile = User.getBasicProfile();
                    //*****************googleUser**************
                    var user_id = profile.getId();

                    //console.log('ID: ' + user_id); // Do not send to your backend! Use an ID token instead.
                    //console.log('Name: ' + profile.getName());
                    //console.log('Image URL: ' + profile.getImageUrl());
                    //console.log('Email: ' + profile.getEmail());

                    // The ID token you need to pass to your backend:
                    var l_RO = User.getAuthResponse();

                    var id_token = l_RO.id_token;
                    //var access_token = l_RO.access_token;
                    //var log_hint = l_RO.login_hint;
                    //var scopes = l_RO.scope;
                    //var expire_time = l_RO.expires_in;
                    //var f_issued_at = l_RO.first_issued_at;
                    //var expires_at = l_RO.expires_at;

                    //console.log("ID Token: " + id_token);
                    //console.log("Access Token: " + access_token);
                    //console.log("Log Hint: " + log_hint);
                    //console.log("Scopes: " + scopes);
                    //console.log("Expire Time: " + expire_time);
                    //console.log("f_issued_at: " + f_issued_at);
                    //console.log("Expires at: " + expire_time);

                    $.post(m_phpLogin, { ID_TOKEN: id_token }, function (data, status) {
                        var indexer = parseInt(data);
                        switch (indexer) {
                            case 0:
                                if (window.location.href === "http://www.luxline.com.mx") {
                                    setTimeout(function () {
                                        window.location.href = "http://www.luxline.com.mx/testLuxFact";
                                    }, 1000);
                                }

                                if(m_btnSignIn !== null)
                                    $(m_btnSignIn).hide();

                                if(m_btnSignOut !== null)
                                    $(m_btnSignOut).show();
                                break;
                            case -1:
                                console.log("Token Invalido");
                                break;
                            case -2:
                                console.log("Estampa de tiempo expirada");
                                break;
                            case -3:
                                if(m_message !== null)
                                    $(m_message).html("<h3>El usuario no existe en la base de datos. Ingrese a su cuenta de Google+ con un usuario válido.</h3>");
                                else
                                    console.log("El usuario no existe en la base de datos. Ingrese a su cuenta de Google+ con un usuario válido.");

                                if (window.location.href !== "http://www.luxline.com.mx") {
                                    setTimeout(function () {
                                        window.location.href = "http://www.luxline.com.mx";
                                    }, 1000);
                                }


                                if(m_btnSignOut !== null)
                                    $(m_btnSignOut).hide();

                                if(m_btnSignIn !== null)
                                    $(m_btnSignIn).show();
                                break;
                            case -4:
                                console.log("Hay inconsistencia en la base de datos");
                                break;
                            default:
                                break;
                        }
                    });
                }
                else {
                    if (m_stayAfterLogOut) //Stay after LogOut
                    {
                        m_stayAfterLogOut = false;
                        return;
                    }

                    if(m_message !== null)
                        m_message.html("<h3>De click a Ingresar para comenzar</h3>")
                    else
                        console.log("De click a Ingresar para comenzar");

                    if(m_btnSignIn !== null)
                        $(m_btnSignIn).show();

                    if(m_btnSignOut !== null)
                        $(m_btnSignOut).hide();


                    $.post("../Login/php/clearSession.php", {}, function () {
                    if (window.location.href !== "http://www.luxline.com.mx") {
                        setTimeout(function () {
                            window.location.href = "http://www.luxline.com.mx";
                        }, 1000);
                    }
                    });

                }
            }

            this.checkforValidCredentials = function () {
                var User = m_auth2.currentUser.get()
                var profile = User.getBasicProfile();
                var user_id = profile.getId();
                var l_RO = User.getAuthResponse();

                var id_token = l_RO.id_token;

                $.post(m_phpLogin, { ID_TOKEN: id_token }, function (data, status) {
                    var indexer = parseInt(data);
                    switch (indexer) {
                        case 0:
                            return 0;
                            break;
                        case -1:
                            return -1;
                            break;
                        case -2:
                            return -2;
                            break;
                        case -3:
                            return -3;
                            break;
                        case -4:
                            return -4;
                            break;
                        default:
                            return -5;
                            break;
                    }
                });
            }

           this.initAuth = function () {
                //make gapi calls
                gapi.client.setApiKey(m_apiKey);
                gapi.auth2.init({
                    client_id: m_clientId,
                    scope: m_scopes,
                    cookie_policy: m_cookie_policy
                }).then(function () {
                    //Obtener instancia de autorización

                    //****************auth2***************************************
                    //auth 2 is a GoogleAuth object that is a singleton class that provides methods to allow
                    //the user to sign in with a Google account, get the user's current
                    //sign-in status, get specific data from the user's Google profile,
                    //request additional scopes, and sign out from the current account.
                    m_auth2 = gapi.auth2.getAuthInstance();
                    //****************auth2***************************************

                    //Víncular un cambio de estado a una función
                    m_auth2.isSignedIn.listen(updateSigninStatus);

                    //Checar el estado inicial, podría ya estar loggeado
                    updateSigninStatus(m_auth2.isSignedIn.get());

                    //Listen to signin states
                    if(m_btnSignIn !== null)
                        m_btnSignIn.addEventListener("click", self.signIn);

                    if(m_btnSignOut !== null)
                        m_btnSignOut.addEventListener("click", self.logOut);
                });
            }

        };

    </script>
    <!--ApiLogIn-->

    <script>
        var go_ApiLogIn = null;
        var authorizeButton = null;
        var signoutButton = null;
        var g_message = null;
        var g_signOutBtn = null;
        var g_signInBtn = null;

        $(document).ready(function () {
            g_message = null;
            g_signInBtn = null;
            g_signOutBtn = document.getElementById('signout-button');

            go_ApiLogIn = new ApiLogIn(g_signInBtn, g_signOutBtn, g_message, "../Login/php/logInFacturacion.php");
            gapi.load('client:auth2', go_ApiLogIn.initAuth);
        });
    </script>

</head>

<body>
    <div id="i_modalBlur">

        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="row visible-xs ">
                    <img src="img/luxline.png" style="height:8%;" id="i_navBarLogo" alt="lux_logo">
                </div>
                <div class="navbar-header" style="margin:1%;">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <img src="img/luxline.png" class="visible-md visible-lg visible-sm" id="i_navBarLogo" alt="lux_logo">
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav" style="margin:1%;">
                        <li><a href="index.html"> Facturar</a></li>
                        <li><a href="folios.html">Folios</a></li>
                        <li><a href="ArgModAtajo.html">Ajustes</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li data-toggle="modal" data-target="#i_modalOpcionesUsuario"><a href="#"><span class="fa fa-user" style="font-size:20px;" aria-hidden="true"></span></a></li>
                        <li data-toggle="modal" data-target="#i_modalCerrarSesion"><a href="#"><span class="fa fa-sign-out" style="font-size:20px;" aria-hidden="true"></span></a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container" id="i_content">

            <h2 style="margin-bottom : 8%;">Agregar Nuevo Usuario</h2>

            <div class="c_marginTitle">
                <h3 style="margin-bottom : 2%; display:inline;">Privilegios</h3><i style="display:inline; margin-left:inherit;" class="fa fa-question-circle fa-2x" data-toggle="modal" data-target="#i_modalAjustesPrincipales"></i>
            </div>
            <hr>

            <div style="margin-bottom: 8%;" class="row c_inputForm">
                <div class="col-sm-12">
                    <label class="radio-inline"><input type="radio" name="optradio">0</label>
                    <label class="radio-inline"><input type="radio" name="optradio">1</label>
                    <label class="radio-inline"><input type="radio" name="optradio">2</label>
                </div>
            </div>


            <div class="c_marginTitle">
                <h3 style="margin-bottom : 2%; display:inline;">Sucursales</h3><i style="display:inline; margin-left:inherit;" class="fa fa-question-circle fa-2x" data-toggle="modal" data-target="#i_modalAjustesPrincipales"></i>
            </div>
                <hr>


                <div class="table-responsive hidden-xs" style="max-height:90%;">
                    <table class="table table-bordered">

                        <thead>

                            <tr>

                                <th></th>

                                <th>Nombre</th>

                                <th>Dirección</th>
                            </tr>

                        </thead>
                        <tbody id="i_tbSucursales">
                            <tr>
                                <td>
                                    <div class="checkbox">
                                        <label><input type="checkbox" value=""></label>
                                    </div>
                                </td>
                                <td>Santa Margarita</td>
                                <td>Las Flores Número 2</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="checkbox">
                                        <label><input type="checkbox" value=""></label>
                                    </div>
                                </td>
                                <td>Santa Margarita</td>
                                <td>Las Flores Número 2</td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="checkbox">
                                        <label><input type="checkbox" value=""></label>
                                    </div>
                                </td>
                                <td>Santa Margarita</td>
                                <td>Las Flores Número 2</td>
                            </tr>
                        </tbody>

                    </table>
                </div>

                <div class="row c_inputForm visible-xs" style="margin-bottom:8%;">
                    <div class="col-sm-12" style="text-align:left; padding-left:25%;" id="i_cbSucursales">

                        <div class="checkbox">
                            <label><input type="checkbox" value="">Santa Margarita</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" value="">Las Flores</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" value="" disabled>La Martinica</label>
                        </div>


                    </div>
                </div>

                <div class="c_marginTitle">
                <h3 style="margin-bottom : 2%; display:inline;">Tipo de Facturación</h3><i style="display:inline; margin-left:inherit;" class="fa fa-question-circle fa-2x" data-toggle="modal" data-target="#i_modalAjustesPrincipales"></i>
                </div>
                <hr>

                <div class="row c_inputForm" style="margin-bottom:10px;">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label for="i_selTipoFactura">Tipo de Factura:</label>
                            <select class="form-control c_input c_userParams" id="i_selTipoFactura">
                                <option value="0"> Productos </option>
                                <option value="1"> Arrendamiento </option>
                                <option value="2"> Honorarios </option>
                            </select>
                        </div>

                    </div>
                </div>

                <div class="row c_inputForm" style="margin-bottom:2%;">
                    <div class="col-sm-12">
                        <div class="well c_input c_userParams" id="i_divFacturasWell">
                            <div class="checkbox" id="i_divRetenerIVA">
                                <label><input type="checkbox" value="">Retener IVA</label>
                            </div>
                            <div class="checkbox" id="i_divRetenerISR">
                                <label><input type="checkbox" value="">Retener ISR</label>
                            </div>

                            <div id="i_divContTasaRet">
                                <label for="">Tasa de Retención</label>
                                <select class="form-control c_input c_userParams" id="i_selTasaRet">
                                    <option> 4.9 </option>
                                    <option> 10 </option>
                                    <option> 15 </option>
                                    <option> 21 </option>
                                    <option> 30 </option>
                                </select>
                            </div>
                    </div>

                </div>
            </div>


                <div class="row c_inputForm">
                    <div class="col-xs-6" style="padding-top:1%;">
                        <button id="i_btnAceptar" onclick="checkUserInputs()" class="btn btn-block c_Accept">Aceptar</button>
                    </div>

                    <div class="col-xs-6" style="padding-top:1%;">
                        <button id="i_btnUnDo" class="btn c_Ajustes btn-block">Deshacer</button>
                    </div>
                </div>

            </div> <!--container -->

    </div><!-- /i_modalBlur -->
    <!--ModalAgregarCliente -->
    <div class="modal fade" id="i_modalAgregarCliente" role="dialog">
        <div class="container">
            <div class="row">
                <div class="col-sm-3"></div>
                <div class="col-sm-6 modal-box" style="margin-top:10px;">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <div id="i_msjSuccess" style="visibility:hidden; margin-top:20px;">

                    </div>
                    <div id="i_msjWarning" style="visibility:hidden; margin-top:20px;">

                    </div>
                </div>
                <div class="col-sm-3">

                </div>
            </div>
            <button class="btn c_Accept btn-default" data-dismiss="modal">Aceptar</button>

        </div>
    </div><!--/ModalAgregarCliente -->
    <!--ModalCerrarSesion-->
    <div class="modal fade" id="i_modalCerrarSesion" role="dialog">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 class="h3Modal">¿Esta seguro que desea cerrar sesión?</h3>

                    <button type="button" class="btn  c_modalDismiss c_AcceptModal" data-dismiss="modal" autofocus id="signout-button">Aceptar</button>
                    <button type="button" class="btn  c_modalDismiss c_Cancel" data-dismiss="modal">Cancelar</button>

                </div>
            </div>
        </div>
    </div><!--/ModalCerrarSesion -->
    <!--ModalOpcionesUsuario-->
    <div class="modal fade" id="i_modalOpcionesUsuario" role="dialog">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 class="h3Modal">¿Seguro que desea ir a ajustes?</h3>
                    <p>Puede que la información no se haya guardado</p>


                    <button onclick="location.href = 'opcionesUsuario.html'" type="button" class="btn  c_modalDismiss c_AcceptModal" data-dismiss="modal" autofocus>Acceder</button>
                    <button type="button" class="btn  c_modalDismiss c_Cancel" data-dismiss="modal">Regresar</button>

                </div>
            </div>
        </div>
    </div><!--/ModalOpcionesUsuario-->

    <script>
        var gd_radio = null;
        var gd_cbContainer = null;
        var gd_tbContainer = null;
        var gd_selTipoFactura = null;
        var gd_divRetenerIVA = null;
        var gd_divRetenerISR = null;
        var gd_divContTasaRet = null;
        var gd_selTasaRet = null;
        //Modal AgregarNuevoUsuario
        var gd_modalAgregarUsuario = null;
        var gd_cubitoWaitingAgregarUsuario = null;
        var gd_contentContainerAgregarUsuario = null;
        var gi_imgAgregarUsuario = null;
        var gd_headerAgregarUsuario = null;
        var gd_pAgregarUsuario = null;
        var gd_footerAgregarUsuario = null;
        var gd_btnGoContinuar = null;
        var gd_btnGoCancelar = null;
        var gd_btnGoAgregar = null;
        var gaa_usuarioParams = null;
        //Modal AgregarNuevoUsuario


        $(document).ready(function () {
            //Modal AgregarNuevoUsuario
            gd_modalAgregarUsuario = $("#i_modalAgregarUsuario");
            gd_cubitoWaitingAgregarUsuario = $("#i_cubitoWaitingAgregarUsuario");
            gd_contentContainerAgregarUsuario = $("#i_contentContainerAgregarUsuario");
            gi_imgAgregarUsuario = $("#i_imgAgregarUsuario");
            gd_headerAgregarUsuario = $("#i_headerAgregarUsuario");
            gd_pAgregarUsuario = $("#i_pAgregarUsuario");
            gd_footerAgregarUsuario = $("#i_footerAgregarUsuario");
            gd_btnGoContinuar = $("#i_btnGoContinuar");
            gd_btnGoCancelar = $("#i_btnGoCancelar");
            gd_btnGoAgregar = $("#i_btnGoAgregar");
            //Modal AgregarNuevoUsuario


            gd_radio = $('input[name=optradio]'); 
            gd_cbContainer = $("#i_cbSucursales");
            gd_tbContainer = $("#i_tbSucursales");
            gd_selTipoFactura = $("#i_selTipoFactura");

            gd_divRetenerIVA = $("#i_divRetenerIVA").find("input");
            gd_divRetenerISR = $("#i_divRetenerISR").find("input");
            gd_divContTasaRet = $("#i_divContTasaRet");
            gd_selTasaRet = $("#i_selTasaRet");
            gd_divFacturasWell = $("#i_divFacturasWell");

            gd_tbContainer.load("php/GetSucursales.php", {});
            gd_cbContainer.load("php/GetSucursalescb.php", {});

            modRetOpciones(gd_selTipoFactura.val());

            //Proceso de Agregar Usuarioi_btnGoAgregar
            gd_btnGoContinuar.click(function () {
                var profile = go_ApiLogIn.getUserProfile();
                var size = parseInt(gaa_usuarioParams.length);
                var la_profile = {
                    Nombre : profile.getName(),
                    Perfil : profile.getId(),
                    Mail : profile.getEmail()
                };
                gaa_usuarioParams[size] = la_profile;


                $.post("php/agregarUsuario.php", { PARAMS: gaa_usuarioParams }, function (data) {
                    if (!parseInt(data)) {
                        gd_headerAgregarUsuario.html("Error de Base de Datos");
                        gd_pAgregarUsuario.html(data);
                        return;
                    }

                    //$("#i_alertAgregarUsuario").show();
                    //$("#i_pAgregarUsuario").html("");
                    //$("#i_headerAgregarUsuario").html("Usuario agregado exitosamente");
                    //updateTableUsuarios();
                    //gd_usrInputDoms.val('');
                    //$("[name=radioPriv]")[0].checked = true;
                    //$(gd_usrInputDoms[6]).prop("checked", false)
                    //$(gd_usrInputDoms[7]).prop("checked", false)
                });


            });

            gd_btnGoAgregar.click(function () {
                gd_cubitoWaitingAgregarUsuario.hide();
                gd_contentContainerAgregarUsuario.show();
                gd_footerAgregarUsuario.hide();
                gi_imgAgregarUsuario.show();
                gd_btnGoContinuar.hide();
                gd_btnGoCancelar.hide();
                gd_btnGoAgregar.hide();

                var lo_profile = null;
                gd_headerAgregarUsuario.text("Espere un momento . . .");
                gd_pAgregarUsuario.hide();
                gd_footerAgregarUsuario.hide();

                setTimeout(function () {
                    if (go_ApiLogIn.checkforValidCredentials() < 0) {
                        gd_headerAgregarUsuario.text("Las credenciales no son válidas");
                        gd_pAgregarUsuario.text("Te recomendamos que vuelvas a iniciar sesión para descartar que tu variable de sesión no haya expirado.");
                        return;
                    }
                    gd_contentContainerAgregarUsuario.hide();
                    gd_cubitoWaitingAgregarUsuario.show();
                    go_ApiLogIn.logOut(true);

                    setTimeout(function () {
                        go_ApiLogIn.m_getProfileInfoLogin = true;
                        go_ApiLogIn.signIn();
                    }, 3000)

                }, 5000);



            });

            gd_selTipoFactura.change(function () {
                modRetOpciones($(this).val());
            });
        });

        function modRetOpciones(indexer) {
            var index = parseInt(indexer);
            switch (index) {
                case 0: //Productos
                    gd_divFacturasWell.hide();
                    break;
                case 1: //Arrendamiento
                    gd_divFacturasWell.show();
                    break;
                case 2: //Honorarios
                    gd_divFacturasWell.show();
                    break;
                default:
                    break;
            }
        }

        function checkUserInputs() {
            var output = [];
            var states = [];
            var radio_priv = gd_radio;
            var radio_fail = true;
            var privilegio = 0;
            radio_priv.each(function (i, element) {
                if ($(element).is(":checked")) {
                    privilegio = i;
                    radio_fail = false;
                }
                
            });
            states[0] = privilegio;

            if (radio_fail) {
                output.push("Debes de seleccionar un privilegio para el usuario");
            }

            var i = 0;
            var checkbox_lg = [];
            gd_tbContainer.children().each(function () {
                var checkbox = $(this).find("input");

                if (checkbox.is(":checked")) {
                    checkbox_lg[i] = checkbox.val();
                    i++;
                }
                    
            });

            i = 0;
            var checkbox_xs = [];
            gd_cbContainer.children().each(function () {
                var checkbox = $(this).find("input");

                if (checkbox.is(":checked")) {
                    checkbox_xs[i] = checkbox.val();
                    i++;
                }
                
            });

            var la_checkbox = [];
            if (checkbox_lg.length > 0)
                la_checkbox = checkbox_lg;
            else if (checkbox_xs.length > 0)
                la_checkbox = checkbox_xs;
            else
                output.push("Debes ingresar al menos una sucursal en la cual el nuevo usuario pueda facturar");

            states[1] = la_checkbox;

            var ln_swIndex = parseInt(gd_selTipoFactura.val());
            var la_factParams = null;
            switch (ln_swIndex) {
                case 0:
                    la_factParams = {
                        tipoFactura : 0,
                        retenerIVA : false,
                        retenerISR : false,
                        tasaRet : 0
                    };
                    break;
                case 1:
                    la_factParams = {
                        tipoFactura: 1,
                        retenerIVA: gd_divRetenerIVA.is(":checked"),
                        retenerISR: gd_divRetenerISR.is(":checked"),
                        tasaRet: gd_selTasaRet.val()
                    };
                    break;
                case 2:
                    la_factParams = {
                        tipoFactura: 2,
                        retenerIVA: gd_divRetenerIVA.is(":checked"),
                        retenerISR: gd_divRetenerISR.is(":checked"),
                        tasaRet: gd_selTasaRet.val()
                    };
                    break;
                default:
                    break;
            }
            states[2] = la_factParams;


            if (output.length > 0) {
                gd_cubitoWaitingAgregarUsuario.hide();
                gd_headerAgregarUsuario.text("Error");
                var ln_it = 0;
                var ln_size = output.length;
                var error_html = [];

                for (ln_it; ln_it < ln_size; ln_it++) {
                    error_html[ln_it] = "<h5>Error " + (ln_it + 1) + ": " + output[ln_it] + "</h5>";
                }
                error_html.join("");

                gd_pAgregarUsuario.html(error_html);
                gd_modalAgregarUsuario.modal('show');
                gd_btnGoAgregar.hide();
                gd_btnGoCancelar.hide();
                gd_btnGoContinuar.hide();
                return;
            }
            else {
                gaa_usuarioParams = states;
                gd_cubitoWaitingAgregarUsuario.hide();
                gd_btnGoAgregar.show();
                gd_btnGoCancelar.show();
                gd_btnGoContinuar.hide();
                gd_headerAgregarUsuario.text("Agregar Usuario");
                gd_pAgregarUsuario.text("¿Esta seguro que desea agregar el nuevo usuario?");
                gd_modalAgregarUsuario.modal('show');
                return;
            }
        }


        // JavaScript source code
        function validateEmail(mail) {
            mail = mail.trim();
            if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)) {
                return true;
            }
            return false;
        }

        function validateName(str) {
            str = str.trim();
            var reg = /^([a-z ñáéíóú]{2,60})$/i;
            //Solo puede contener letras y espacios
            if (reg.test(str))
                return true;

            else
                return false;
        }

        function validateCalle(str) {
            str = str.trim();
            //Solo puede contener letras y espacios

            if (/^([a-zñáéíóú.A-ZÑ.]+\s)*[a-zñáéíóú.A-ZÑ.]+$/.test(str))
                return true;

            else
                return false;
        }

        function validateRFC(str) {
            str = str.trim();

            if (str.match(/^[a-zA-Z0-9.-]*$/)) {
                if (str.length === 12) { //Persona moral
                    var Nombre = str.substr(0, 3);
                    var Fecha = str.substr(3, 6);
                    var Homoclave = str.substr(9, 3);

                    if (!validateAlpha(Nombre))
                        return "Los primeros 3 digitos del RFC tienen que ser letras del alfabeto para Personas Morales";


                    if (!validateNumeric(Fecha))
                        return "Los digitos del quinto al octavo del RFC estan conformados por la fecha de nacimiento y solo pueden ser valores numéricos";


                    if (!validateAlphaOrNumericOrAlphaNumeric(Homoclave))
                        return "Los últimos tres elementos del RFC solo pueden ser alphanuméricos, sin espacios ni caracteres que no se encuentren en el alfabeto";

                    return true;
                }

                else if (str.length === 13) { //Personas fisicas
                    var Nombre = str.substr(0, 4);
                    var Fecha = str.substr(4, 6);
                    var Homoclave = str.substr(10, 3);

                    if (!validateAlpha(Nombre))
                        return "Los primeros 4 digitos del RFC tienen que ser letras del alfabeto para Personas Fisicas";


                    if (!validateNumeric(Fecha))
                        return "Los digitos del quinto al octavo del RFC estan conformados por la fecha de nacimiento y solo pueden ser valores numéricos";


                    if (!validateAlphaOrNumericOrAlphaNumeric(Homoclave))
                        return "Los últimos tres elementos del RFC solo pueden ser alphanuméricos, sin espacios ni caracteres que no se encuentren en el alfabeto";


                    return true;
                }
                else
                    return "El RFC debe contener exactamente 14 elementos para personas fisicas y 13 para personas morales";

                return true;
            }

            else
                return "El RFC solo puede contener letras y números";
        }

        function validateNumeric(str) {
            str = str.trim();
            if (str === true || str === false)
                return false;

            if (str === '')
                return false;

            if (isNaN(str))
                return false;

            else
                return true;
        }

        function validateAlpha(str) {
            str = str.trim();
            if (str.match(/[0-9]/i))
                return false;
            else
                return true;
        }
        function validateAlphaNumeric(str) {
            str = str.trim();
            // Which allows only Alphanumeric.

            //It doesn't allow:

            // Only Alpha
            // Only Numbers

            if (str.match(/((^[0-9]+[a-z]+)|(^[a-z]+[0-9]+))+[0-9a-z]+$/i))
                return true;
            else
                return false;
        }

        function validateAlphaOrNumericOrAlphaNumeric(str) {
            str = str.trim();
            // Which allows Alphanumeric.
            // Alpha
            // Numbers
            if (str.match(/^([0-9]|[a-z])+([0-9a-z ]+)$/i))
                return true;
            else
                return false;
        }


    </script>

    <div class="modal fade" id="i_modalAgregarUsuario" role="dialog">
        <div class="container">
            <div class="row" id="i_cubitoWaitingAgregarUsuario">
                <div class="col-xs-12">
                    <div class="sk-cube-grid">
                        <div class="sk-cube sk-cube1"></div>
                        <div class="sk-cube sk-cube2"></div>
                        <div class="sk-cube sk-cube3"></div>
                        <div class="sk-cube sk-cube4"></div>
                        <div class="sk-cube sk-cube5"></div>
                        <div class="sk-cube sk-cube6"></div>
                        <div class="sk-cube sk-cube7"></div>
                        <div class="sk-cube sk-cube8"></div>
                        <div class="sk-cube sk-cube9"></div>
                    </div>
                </div>
            </div>
            <div class="row" id="i_contentContainerAgregarUsuario">
                <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

                    <img class="img-circle c_imgAddUser" id="i_imgAgregarUsuario" src="" />
                    <h3 id="i_headerAgregarUsuario" style="font-weight:bolder;">Agregar Usuario</h3>
                    <div class="c_infocontainer" id="i_pAgregarUsuario">

                    </div>
                    <h4 id="i_footerAgregarUsuario" hidden>Asegurese que los datos anteriores son correctos antes de continuar</h4>

                    <button id="i_btnGoAgregar" type="button" class="btn  c_modalDismiss c_AcceptModal" autofocus>Continuar</button>
                    <button id="i_btnGoContinuar" type="button" class="btn  c_modalDismiss c_AcceptModal" hidden>Continuar</button>
                    <button id="i_btnGoCancelar" type="button" class="btn btn-default c_Cancel c_modalDismiss" autofocus data-dismiss="modal">Cancelar</button>


                </div>
            </div>
        </div>
    </div>


</body> <!--Termina BODY-->
</html> <!--Termina HTML-->
