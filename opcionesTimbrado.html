<?php
require_once("../Login/php/Functions.php");   
$link = linkDBLuxLine();
$luxlineObj = new luxlineWebLogin($link);

$luxlineObj->initialCheckUpSystems();
?>

<!--Desarrollado por Luxline Solutions-->
<html lang="en">    
<head>  <!--HEAD-->
    <title>Opciones de factura timbrada</title>
    <!--MetaArea-->
    <meta charset="utf-8"> <!--Caracteres Codificados-->
    <meta name="viewport" content="width=device-width, initial-scale=1"> <!--Para Dispositivos Moviles habilita touch-zoom etc-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--/MetaArea-->
    
    <!--CSS-->
    <link href="css/bootstrap.min.css" rel="stylesheet"><!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
    <link rel="icon" href="img/luxline1.ico" type="image/x-icon">
    <!--/CSS-->
    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!--/JS-->
    <!--Google+ api-->
    <script src="https://apis.google.com/js/api.js?onload=handleClientLoad"></script>
    <!--Google+ api-->
    <!--ApiLogIn-->
    <script>
        var ApiLogIn = function (btnSingIn, btnSignOut, msgContainer,phpLogin) {
            //var test = 10; private variable
            //var method = function(){} private method
            //this.test = 10; public variable
            //this.method = function(){} public method
            var self = this;
            var m_auth2 = null; // The Sign-In object.
            var m_btnSignIn = btnSingIn;
            var m_btnSignOut = btnSignOut;
            var m_message = msgContainer;
            var m_apiKey = 'accesssecurity-140019';
            var m_clientId = "1043488027097-f77grlc3h5cli90m6c0b4urra6jmcakn.apps.googleusercontent.com";
            var m_phpLogin = phpLogin;
            // Enter one or more authorization scopes. Refer to the documentation for
            // the API or https://developers.google.com/identity/protocols/googlescopes
            // for details.
            var m_scopes = 'profile https://www.googleapis.com/auth/userinfo.profile';
            var m_cookie_policy = 'single_host_origin';


            this.signIn = function () {
                m_auth2.signIn();
            }

            this.logOut = function () {
                var User = m_auth2.currentUser.get();
                var l_RO = User.getAuthResponse();
                var access_token = l_RO.access_token;

                var location = (parseInt(screen.availWidth) / 2) - 290;
                var revokeUrl = window.open('https://accounts.google.com/Logout', "Logout", "left=" + location + ",top=10 width=580,height=800");
                revokeUrl.focus();
                setTimeout(function () {
                    revokeUrl.close();
                }, 500);
            }

            var updateSigninStatus = function (isSignedIn) { //Callback function
                if (isSignedIn) {
                    //*****************googleUser**************
                    //A GoogleUser object represents one user account.
                    var User = m_auth2.currentUser.get()
                    var profile = User.getBasicProfile();
                    //*****************googleUser**************
                    var user_id = profile.getId();

                    //console.log('ID: ' + user_id); // Do not send to your backend! Use an ID token instead.
                    //console.log('Name: ' + profile.getName());
                    //console.log('Image URL: ' + profile.getImageUrl());
                    //console.log('Email: ' + profile.getEmail());

                    // The ID token you need to pass to your backend:
                    var l_RO = User.getAuthResponse();

                    var id_token = l_RO.id_token;
                    //var access_token = l_RO.access_token;
                    //var log_hint = l_RO.login_hint;
                    //var scopes = l_RO.scope;
                    //var expire_time = l_RO.expires_in;
                    //var f_issued_at = l_RO.first_issued_at;
                    //var expires_at = l_RO.expires_at;

                    //console.log("ID Token: " + id_token);
                    //console.log("Access Token: " + access_token);
                    //console.log("Log Hint: " + log_hint);
                    //console.log("Scopes: " + scopes);
                    //console.log("Expire Time: " + expire_time);
                    //console.log("f_issued_at: " + f_issued_at);
                    //console.log("Expires at: " + expire_time);

                    $.post(m_phpLogin, { ID_TOKEN: id_token }, function (data, status) {
                        var indexer = parseInt(data);
                        switch (indexer) {
                            case 0:
                                if (window.location.href === "http://www.luxline.com.mx") {
                                    setTimeout(function () {
                                        window.location.href = "http://www.luxline.com.mx/testLuxFact";
                                    }, 1000);
                                }

                                if(m_btnSignIn !== null)
                                    $(m_btnSignIn).hide();

                                if(m_btnSignOut !== null)
                                    $(m_btnSignOut).show();
                                break;
                            case -1:
                                console.log("Token Invalido");
                                break;
                            case -2:
                                console.log("Estampa de tiempo expirada");
                                break;
                            case -3:
                                if(m_message !== null)
                                    $(m_message).html("<h3>El usuario no existe en la base de datos. Ingrese a su cuenta de Google+ con un usuario válido.</h3>");
                                else
                                    console.log("El usuario no existe en la base de datos. Ingrese a su cuenta de Google+ con un usuario válido.");

                                if (window.location.href !== "http://www.luxline.com.mx") {
                                    setTimeout(function () {
                                        window.location.href = "http://www.luxline.com.mx";
                                    }, 1000);
                                }


                                if(m_btnSignOut !== null)
                                    $(m_btnSignOut).hide();

                                if(m_btnSignIn !== null)
                                    $(m_btnSignIn).show();
                                break;
                            case -4:
                                console.log("Hay inconsistencia en la base de datos");
                                break;
                            default:
                                break;
                        }
                    });
                }
                else {
                    if(m_message !== null)
                        m_message.html("<h3>De click a Ingresar para comenzar</h3>")
                    else
                        console.log("De click a Ingresar para comenzar");

                    if(m_btnSignIn !== null)
                        $(m_btnSignIn).show();

                    if(m_btnSignOut !== null)
                        $(m_btnSignOut).hide();


                    $.post("../../Login/php/clearSession.php", {}, function () {
                    if (window.location.href !== "http://www.luxline.com.mx") {
                        setTimeout(function () {
                            window.location.href = "http://www.luxline.com.mx";
                        }, 1000);
                    }
                    });

                }
            }

           this.initAuth = function () {
                //make gapi calls
                gapi.client.setApiKey(m_apiKey);
                gapi.auth2.init({
                    client_id: m_clientId,
                    scope: m_scopes,
                    cookie_policy: m_cookie_policy
                }).then(function () {
                    //Obtener instancia de autorización

                    //****************auth2***************************************
                    //auth 2 is a GoogleAuth object that is a singleton class that provides methods to allow
                    //the user to sign in with a Google account, get the user's current
                    //sign-in status, get specific data from the user's Google profile,
                    //request additional scopes, and sign out from the current account.
                    m_auth2 = gapi.auth2.getAuthInstance();
                    //****************auth2***************************************

                    //Víncular un cambio de estado a una función

                    m_auth2.isSignedIn.listen(updateSigninStatus);

                    //Checar el estado inicial, podría ya estar loggeado
                    updateSigninStatus(m_auth2.isSignedIn.get());

                    //Listen to signin states
                    if(m_btnSignIn !== null)
                        m_btnSignIn.addEventListener("click", self.signIn);

                    if(m_btnSignOut !== null)
                        m_btnSignOut.addEventListener("click", self.logOut);
                });
            }

        };

    </script>
    <!--ApiLogIn-->

    <script>
        var go_ApiLogIn = null;
        var authorizeButton = null;
        var signoutButton = null;
        var g_message = null;
        var g_signOutBtn = null;
        var g_signInBtn = null;

        $(document).ready(function () {
            g_message = null;
            g_signInBtn = null;
            g_signOutBtn = document.getElementById('signout-button');

            go_ApiLogIn = new ApiLogIn(g_signInBtn, g_signOutBtn, g_message, "../../Login/php/logInFacturacion.php");
            gapi.load('client:auth2', go_ApiLogIn.initAuth);
        });
    </script>


</head> 
<body> 
    <?php   if(!isset($_GET['id'])&&!isset($_GET['folio'])){echo "<script>location.href = 'index.html'</script>"; } ?>

<div id = "i_modalBlur">



      <nav class="navbar navbar-default">

          <div class="container-fluid">

              <div class="row visible-xs ">

                  <img src="img/luxline.png" style="height:8%;" id="i_navBarLogo" alt="lux_logo">

              </div>

              <div class="navbar-header" style="margin:1%;">

                  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">

                      <span class="icon-bar"></span>

                      <span class="icon-bar"></span>

                      <span class="icon-bar"></span>

                  </button>

                  <img src="img/luxline.png" class="visible-md visible-lg visible-sm" id="i_navBarLogo" alt="lux_logo">

              </div>

              <div class="collapse navbar-collapse" id="myNavbar">

                  <ul class="nav navbar-nav" style="margin:1%;">

                      <li><a href="index.html"> Facturar</a></li>

                      <li><a href="folios.html">Folios</a></li>

                      <li><a href="AgrModAtajo.html">Ajustes</a></li>

                  </ul>

                  <ul class="nav navbar-nav navbar-right">

                      <li data-toggle="modal" data-target="#i_modalOpcionesUsuario"><a href="#"><span class="fa fa-user" style="font-size:20px;" aria-hidden="true"></span></a></li>

                      <li data-toggle="modal" data-target="#i_modalCerrarSesion"><a href="#"><span class="fa fa-sign-out" style="font-size:20px;" aria-hidden="true"></span></a></li>

                  </ul>

              </div>

          </div>

      </nav>





  



 <div class = "container" id = "i_content"> 
    
     <ul class="nav nav-pills">
         <li class="active"><a data-toggle="pill" href="#menu_enviar">Enviar Correos</a></li>
         <li><a data-toggle="pill" href="#menu_factura">Factura</a></li>
         <li><a data-toggle="pill" href="#menu_cancelar">Cancelar Factura</a></li>
     </ul>

     <div class="tab-content">
         <div id="menu_enviar" class="tab-pane fade in active">
             <div class="row">
                 <div class="col-xs-12">
                     <div class="c_roundedBackground c_background" style="margin:2%">
                         <h3 style="margin-bottom:3%;">Correos para Enviar</h3>
                         <div class="table-responsive table-responsiveCorreo">
                             <table class="table table-bordered">
                                 <thead>
                                     <tr>
                                         <th>
                                             <input placeholder="Correo Electrónico" type="text" id="i_inputCorreo" class="form-control c_input" />
                                         </th>
                                         <th>
                                             <button class="btn btn-block c_Accept" id="i_btnAgregarCorreo"><i class="fa fa-plus" style="font-size:20px;" aria-hidden="true"></i></button>
                                         </th>
                                     </tr>
                                 </thead>
                                 <tbody id="i_tableCorreosAgregados" "></tbody>

                             </table>
                         </div><!-- table-responsive -->

                         <button class="btn btn-lg c_Accept" onclick="loadCorreosAlModal()">Enviar</button>

                     </div> <!--/c_roundedBackground -->

                 </div> <!--/col Correo Enviar -->
             </div>
         </div>
         <div id="menu_factura" class="tab-pane fade">
             <h3>Cliente</h3>
             <hr />

             <div class="row">
                 <div class="col-xs-12">
                     <div class="table-responsive">
                         <table class="table table-bordered">
                             <thead>
                                 <tr>
                                     <th>Nombre</th>
                                     <th>RFC</th>
                                 </tr>
                             </thead>
                             <tbody id="i_tableCliente">

                             </tbody>
                         </table>

                     </div>


                 </div>

             </div>
             <h3>Factura</h3>
             <hr />
             <div class="row">
                 <div class="col-xs-12">

                     <div class="table-responsive">
                         <table class="table table-bordered">
                             <thead>
                                 <tr>
                                     <th>Folio</th>
                                     <th>Tipo de factura</th>
                                     <th>Metodo de pago</th>
                                     <th>Forma de pago</th>
                                     <th>UUID</th>
                                     <th>Fecha</th>
                                 </tr>
                             </thead>
                             <tbody id="i_tableFacturaParams">

                             </tbody>

                         </table>
                     </div>
                 </div>

             </div>
             <h3>Conceptos</h3>
             <hr />
             <div class="row">
                 <div class="col-xs-12">
                     <div class="table-responsive">
                         <table class="table table-bordered">
                             <thead>
                                 <tr>
                                     <th>Descripción</th>
                                     <th>No.Serie</th>
                                     <th>Unidad</th>
                                     <th>Cantidad</th>
                                     <th>Precio Unitario</th>
                                     <th>Importe</th>
                                 </tr>

                             </thead>
                             <tbody id="i_tableConceptos">

                             </tbody>

                         </table>

                     </div>

                 </div>

             </div>
             <div class="row">
                 <div class="col-xs-12">
                     <div class="table-responsive">
                         <table id="i_tableTotals" class="table table-bordered">

                         </table>

                     </div>

                 </div>

             </div>
           
             <div id="i_tableRetHead" class="row">
                 <h3>Retenciones</h3>
                 <hr />
                 <div class="col-xs-12">
                     <div class="table-responsive">
                         <table class="table table-bordered">
                             <thead>
                                 <tr>
                                     <th id="i_hRetIsr">Retencion ISR</th>
                                     <th>Retención IVA (2/3 partes)</th>
                                 </tr>
                             </thead>
                             <tbody id="i_tableRet"></tbody>
                         </table>

                     </div>

                 </div>

             </div>
             <div class="row">
                 <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                     <button id="i_btnAbrirPDF" class="btn c_Undo btn-block c_AcceptModal btn-block">Abrir PDF</button>

                 </div>
                 <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                 <button id="i_btnAbrirXML" class="btn c_Undo btn-block c_AcceptModal btn-block">Abrir XML</button>
                </div>

                 </div>
             </div>


         <div id="menu_cancelar" class="tab-pane fade">
             <div class="row">
                 <div class="col-xs-12">
                     <div class="c_roundedBackground c_background" style="margin:2%">
                         <h3 style="margin-bottom:3%;">Opciones de Factura</h3>

                         <button id="i_btnCancelarFactura" class="btn btn-primary btn-block c_Cancel">Cancelar Factura</button>


                     </div><!--/c_roundedBackground -->

                 </div><!--/col -->

             </div>
             <div class="row">
                 <div class="col-xs-12">
                     <div id="i_alertDanger" class="alert alert-danger">
                         <button onclick="closeAlert()" value="v_alertDang" class="close" aria-label="close">&times;</button>
                         <strong> <span class="glyphicon glyphicon-ok"></span> La factura se ha cancelado exitosamente</strong>
                     </div>
                 </div>
             </div>

         </div>
     </div>



   


    


    </div> <!--/Container--> 
    
 </div> <!-- /i_modalBlur --> 
 

    <!--ModalMessageEnviadosPorDefault -->
    <div class="modal fade" id="i_modalEnviarCorreo" role="dialog">

        <div class="container">

            <div class="row">

                <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 class = "h3Modal">Correo Electrónico</h3>
                    <hr />
                    <label for="i_inputAsunto">Asunto</label>
                    <input  type="text" id="i_inputAsunto" class="form-control c_input"/>
                    <label for="i_inputCorreoMsg">Cuerpo</label>
                    <textarea class="form-control c_input" id="i_inputCorreoMsg"></textarea>
                    <hr />

                    <button value="" id="i_btnAceptarPlantillaMail" class="btn btn-primary c_Accept" style = "margin-bottom: 3%;">Aceptar</button>

                    <div id="i_alertMailParams">
              
                   <div class="alert alert-success">
                                 
                                 <i class="fa fa-3x fa-check-circle" style = "display:block;" aria-hidden="true"></i>
                                 <strong style = "display:block;" >Se ha guardado el mensaje</strong>
                                 <p id="i_msgCorreos"></p>
                    </div>            
                    </div>
                </div>

            </div>

        </div>

    </div><!--/ModalMessageEnviadosPorDefault -->

    <!--ModalPreview -->
    <input hidden id="i_folioGET" type="text" value="<?php  echo $_GET['folio'];echo':';echo $_GET['id']; ?>" />
    <div class="modal fade" id="modalPreview" role="dialog">
     <div class="sk-cube-grid">
      <div class="sk-cube sk-cube1"></div>
      <div class="sk-cube sk-cube2"></div>
      <div class="sk-cube sk-cube3"></div>
      <div class="sk-cube sk-cube4"></div>
      <div class="sk-cube sk-cube5"></div>
      <div class="sk-cube sk-cube6"></div>
      <div class="sk-cube sk-cube7"></div>
      <div class="sk-cube sk-cube8"></div>
      <div class="sk-cube sk-cube9"></div>
     </div>
</div><!--/ModalPreview -->

    <!--ModalMessageEnvioCorreo -->
    <div class="modal fade" id="i_modalEnvioCorreo" role="dialog">
           <div class="container" >
            <div class="row" id="i_cubitoWaiting">
                <div class="col-xs-12">

                    <div class="sk-cube-grid">

                        <div class="sk-cube sk-cube1"></div>

                        <div class="sk-cube sk-cube2"></div>

                        <div class="sk-cube sk-cube3"></div>

                        <div class="sk-cube sk-cube4"></div>

                        <div class="sk-cube sk-cube5"></div>

                        <div class="sk-cube sk-cube6"></div>

                        <div class="sk-cube sk-cube7"></div>

                        <div class="sk-cube sk-cube8"></div>

                        <div class="sk-cube sk-cube9"></div>

                    </div>

                </div>
            </div>
             <div class="row" id="i_enviarCorreosContent">
                 <div class="col-xs-3">

                 </div>
              <div class="col-xs-6  text-center modal-box">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                      <h4 class="h3Modal">¿Esta seguro que desea enviar la factura a los siguientes clientes?</h4>

                  <div class="alert alert-success" id="i_enviarCorreosConfirmacion" style="display: block;">  
                      <table class="table table-responsive">
                          <thead>
                              <tr>
                                  <td>Correo</td>
                                  <td>Status</td>
                              </tr>
                          </thead>
                          <tbody>
                              <tr>
                                  <td>i44_jorge@hotmail.com</td>
                                  <td>i44_jorge@hotmail.com</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>


                      <button id="i_modalBotonEnviarCorreosEnviar" onclick="enviarCorreo()" type="button" class="btn btn-default c_modalDismiss c_Accept" autofocus>Aceptar</button>

                      <button id="i_modalBotonEnviarCorreosCancelar" type="button" class="btn btn-default c_modalDismiss c_Cancel" data-dismiss="modal">Cancelar</button>

                      <button id="i_modalBotonEnviarCorreosTerminar" type="button" class="btn btn-default c_modalDismiss c_Cancel" data-dismiss="modal">Terminar</button>



                  </div>
                 <div class="col-xs-3">

                 </div>
            </div>
           </div>
        </div><!--/ModalMessageEnvioCorreo -->
        
    <!--ModalMessageCancelarFactura -->
   <div class="modal fade" id="i_modalCancelarFactura" role="dialog">
           <div class="container">
             <div class="row">
              <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                  
                  <h3 class = "h3Modal">¿Seguro que desea cancelar la factura?</h3>
                  
                  <h3>Esta factura no podra volver a ser timbrada</h3>
                  
                  <button id="i_btnTriggerCancelarFactura" type="button" class="btn btn-default c_modalDismiss c_Accept" data-dismiss="modal" autofocus>Aceptar</button>
                  <button type="button" class="btn btn-default c_modalDismiss c_Cancel" data-dismiss="modal">Cancelar</button>
                  
                  
             </div>
            </div>
           </div>
        </div><!--/ModalMessageCancelarFactura -->
    <div class="modal fade" id="i_modalOpcionesUsuario" role="dialog">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

                    <h3 class="h3Modal">¿Seguro que desea ir a configuraciones?</h3>

                    <h3>Puede que la información no se haya guardado</h3>

                    <button onclick="location.href='opcionesUsuario.html'" type="button" class="btn btn-default c_modalDismiss c_Accept" data-dismiss="modal" autofocus>Aceptar</button>
                    <button type="button" class="btn btn-default c_modalDismiss c_Cancel" data-dismiss="modal">Cancelar</button>


                </div>
            </div>
        </div>
    </div>
     <!--ModalMessageCamposVacios -->
   <div class="modal fade" id="i_modalCamposVacios" role="dialog">
           <div class="container">
             <div class="row">
              <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                  
                  <h3 class = "h3Modal">Los campos no pueden estar vacios</h3>
                  
                  <p>Verifique que todos los campos correspondan adecuadamente.</p>
                  
                  <button type="button" class="btn btn-default c_modalDismiss c_Accept" data-dismiss="modal" autofocus>Aceptar</button>
                  <button type="button" class="btn btn-default c_modalDismiss c_Cancel" data-dismiss="modal">Cancelar</button>
                  
                  
             </div>
            </div>
           </div>
        </div><!--/ModalMessageCamposVacios -->
    
    <!--ModalMessageCorreoInvalido -->
   <div class="modal fade" id="i_modalCorreoInvalido" role="dialog">
           <div class="container">
             <div class="row">
              <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                  
                  <h3 class = "h3Modal">Correo Invalido</h3>
                  
                  <p>Verifique que el correo corresponda adecuadamente.</p>
                  
                  <button type="button" class="btn btn-default c_modalDismiss c_Accept" data-dismiss="modal" autofocus>Aceptar</button>
                  <button type="button" class="btn btn-default c_modalDismiss c_Cancel" data-dismiss="modal">Cancelar</button>
             </div>
            </div>
           </div>
        </div><!--/ModalMessageCorreoInvalido -->


    <!--Modal MSG-->
    <div class="modal fade" id="i_modalMsg" role="dialog">
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3 text-center modal-box">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>

                    <h3 class="h3Modal titulo"></h3>

                    <p class="cuerpo1"></p>
                    <p class="cuerpo2"></p>

                    <button type="button" class="btn btn-default c_modalDismiss
                            c_Accept" data-dismiss="modal" id="i_aceptar"  autofocus>
                        Aceptar
                    </button>
                    <button type="button" class="btn btn-default c_modalDismiss
                            c_Cancel" data-dismiss="modal" id="i_cancelar" >
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div><!--Modal MSG-->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script> 
    
    <script src="js/alertMsg.js"></script>

    <script>
        var g_alertMsg = new alertMsg('i_modalMsg', 'i_aceptar', 'i_cancelar',false,true);

        var gd_inputCorreo = $("#i_inputCorreo");
            var gd_tableCorreos = $("#i_tableCorreosAgregados");
            var gd_modalEnviarCorreos = $("#i_modalEnvioCorreo");
            var gd_correosContainer = $("#i_enviarCorreosConfirmacion");
            var gm_correos = new Map();
            var gm_correosMail2Order = new Map();
            var ga_correosOrder2Mail = [];
            var gn_folio = 0;
            var gn_idCliente = 0;
            var gd_cubitoWaiting = $("#i_cubitoWaiting");
            var gd_enviarCorreosContent = $("#i_enviarCorreosContent");
            var gd_modalBotonEnviarCorreosEnviar = $("#i_modalBotonEnviarCorreosEnviar");
            var gd_modalBotonEnviarCorreosCancelar = $("#i_modalBotonEnviarCorreosCancelar");
            var gd_modalBotonEnviarCorreosTerminar = $("#i_modalBotonEnviarCorreosTerminar");
            var gd_modalAgregarAsuntoCuerpo = $("#i_modalEnviarCorreo");

            $("#i_btnTriggerCancelarFactura").click(function(){
                $("#i_modalCancelarFactura").modal("hide");
                $("#modalPreview").modal("show");

                $.post("Facturacion/cancelarFactura.php", { folio: gn_folio }, function (data) {
                 data = data.trim()   
                 var res = JSON.parse(data);
                    switch (parseInt(res['status'])) {
                        case 0: //Todo bien
                            $("#modalPreview").modal("hide");
                            g_alertMsg.show(
                                'Factura Cancelada exitosamente',
                                '  ',
                                res['error'],
                                 {
                                     "function": function (params) {
                                         var folder = params[0];
                                         window.location.href = "https://www.luxline.com.mx/" + folder;
                                     },
                                     "params":[res["folder"]]
                                 },
                                 {
                                     "function": function (params) {
                                         var folder = params[0];
                                         window.location.href = "https://www.luxline.com.mx/" + folder;
                                     },
                                     "params":[res["folder"]]
                                 });
                            break;
                        case -1: //Se chingo
                            $("#modalPreview").modal("hide");
                            g_alertMsg.show(
                                'Error en la cancelación',
                                'La factura no pudo ser cancelado debido a lo siguiente: ',
                                res["error"],
                                 {
                                     "function": function (params) {
                                         var folder = params[0];
                                         window.location.href = "https://www.luxline.com.mx/" + folder;
                                     },
                                     "params": [res["folder"]]
                                 },
                                 {
                                     "function": function (params) {
                                         var folder = params[0];
                                         window.location.href = "https://www.luxline.com.mx/" + folder;
                                     },
                                     "params": [res["folder"]]
                                 });
                            break;
                        default:
                            $("#modalPreview").modal("hide");
                            break;
                    }

                });
            });
            var gd_tableConceptos = null;
            var gd_tableTotals = null;
            var gd_tableHeaderRet = null;
            var gd_tableRet= null;
            $("#i_btnAbrirPDF").click(function(){
                var xml_file =this.value;
                var pdf_file = xml_file.split(".xml")[0];
                pdf_file = pdf_file +".pdf";

                window.open("printPDF.php?pdfFile="+pdf_file+"&type=1");

            });

            $(document).ready(function () {

                $("#i_btnAbrirXML").click(function(){
                  window.open("Facturacion/facturas/timbradas/xml/"+this.value);

                });
                gd_tableHeaderRet = $("#i_tableRetHead");
                gd_tableRet =$("#i_tableRet");
                gd_tableHeaderRet.hide();

                gd_tableConceptos =   $("#i_tableConceptos");
                gd_tableTotals =  $("#i_tableTotals");
                var folio ="<?php echo $_GET['folio']; ?>";
                $.post("php/getFacturaXML.php", { folio: folio }, function (data) {
                    try{
                        var tmp = data.split("&%$");
                        var html_conceptos = tmp[0];
                        var html_totales =tmp[1];
                        var html_retencion = tmp[2];
                        gd_tableConceptos.html(html_conceptos);
                        gd_tableTotals.html(html_totales);
                        $('[data-toggle="popover"]').popover();

                        var factura_params = tmp[4];
                        var xml_file = tmp[5];
                        $("#i_btnAbrirPDF").val(xml_file);
                     $("#i_btnAbrirXML").val(xml_file);

                        factura_params = JSON.parse(factura_params);
                        $("#i_tableCliente").html("<tr><td>"+factura_params.cliente+"  &nbsp&nbsp&nbsp<button onclick='window.open(\"modificarCliente.html?id="+factura_params.idcliente+"\")' class='c_modificarBtn btn btn-lg c_Ajustes'><i class='fa fa-cog' aria-hidden='true'></i></button> </td><td>"+factura_params.rfc+"</td></tr>");

                        var tipo = '';
                        var tmp_folio =factura_params.folio;
                        if(tmp_folio.search("A")!=-1){
                            tipo ="Productos";
                        }
                        if(tmp_folio.search("B")!=-1){
                            tipo ="Arrendamiento";
                        }
                        if(tmp_folio.search("C")!=-1){
                            tipo ="Honorarios";
                        }

                        $("#i_tableFacturaParams").html("<tr><td>"+factura_params.folio+"</td><td>"+tipo+"</td><td>"+factura_params.metodo_pago+"</td><td>"+factura_params.forma_pago+"</td><td>"+factura_params.UUID+"</td><td>"+factura_params.fecha+"</td></tr>");




                        if(html_retencion!=""){
                            gd_tableHeaderRet.show();
                            gd_tableRet.html(html_retencion);
                            var porcentaje_isr = tmp[3];
                            $("#i_hRetIsr").html("Retención de ISR (%"+porcentaje_isr+")");
                        }
                    }catch(err){

                        console.log(err);
                        alert("No se ha podido cargar esta factura");
                        location.href="index.html";
                    }


                });
                $.post("php/getCorreoDefaultTimbrada.php", function (data) {

                    var lj_datos = JSON.parse(data);
                    var lj_correos = lj_datos.result0; var len = lj_correos.length; var i = 0;
                    var cuerpo = lj_datos.result1[0].mensaje_timbrada; var asunto = 'Comprobante fiscal Timbrado';
                    var tmp = { asunto: asunto, cuerpo: cuerpo };
                    for (; i < len; i++) {

                        gm_correos.set(lj_correos[i].email, tmp);

                        gm_correosMail2Order.set(lj_correos[i].email, i);

                        ga_correosOrder2Mail[i] = lj_correos[i].email;

                    }
                    update_mailTable();

                });

                $("#i_alertFalloEnviar").hide();

                $("#i_alertSeEnvio").hide();


                var getInfo = $("#i_folioGET").val();
                var tmp = getInfo.split(":");
                gn_folio = tmp[0];
                gn_idCliente = tmp[1];
                $("#i_alertSuccess").hide();
                $("#i_alertDanger").hide();
                $("#i_alertMailParams").hide();

            });


            function loadCorreosAlModal() {

                gd_enviarCorreosContent.show();

                gd_cubitoWaiting.hide();

                gd_modalBotonEnviarCorreosEnviar.show();

                gd_modalBotonEnviarCorreosCancelar.show();

                gd_modalBotonEnviarCorreosTerminar.hide();



                gd_modalEnviarCorreos.modal("show");

                gd_correosContainer.empty();

                var ln_indexer = 0;
                var ls_html = '<div class="table-responsive">' +

                    '<table class="table">' +

                             '<thead>' +

                                      '<tr>' +

                                          '<td>Correo</td>' +

                                          '<td>Status</td>' +

                                      '</tr>' +

                                  '</thead>' +

                    '<tbody>';





                ga_correosOrder2Mail.forEach(function (i, element) {



                    //gd_correosContainer.append('<ul id="Correo_' + ln_indexer + '"><li><span><strong style="display:inline; margin-right:10px;">' + i + '</strong></span><span><i class="fa fa-question-circle" style="display:inline; color:dimgrey;" aria-hidden="true"></i></span></li></ul>');

                    ls_html = ls_html +

                                 '<tr id = "Correo_' + ln_indexer + '">' +

                                          '<td>' + i + '</td>' +

                                          '<td><i class="fa fa-question-circle"></i></td>' +

                                 '</tr>';



                    ln_indexer++;

                });



                ls_html = ls_html + '</tbody>' +

                             '</table>' +

                            '</div>';

                gd_correosContainer.append(ls_html);

            }

            function enviarCorreo()
            {

                gd_enviarCorreosContent.hide(500);

                gd_cubitoWaiting.show(500);

                gd_modalBotonEnviarCorreosEnviar.hide();

                gd_modalBotonEnviarCorreosCancelar.hide();

                gd_modalBotonEnviarCorreosTerminar.show();



                var buf = [];

                gm_correos.forEach(function (value, key, gm_correos) {

                    var asunto = value.asunto;

                    var cuerpo = value.cuerpo;

                    buf.push({ mail: key, asunto: asunto, cuerpo: cuerpo });

                });

                $.post("php/enviarCorreosJAGS2.php", { UI: 1, folio: gn_folio, idCliente: gn_idCliente, jCorreos: JSON.stringify(buf) }, function (data) {
                    //console.log(data);

                    var correos = JSON.parse(data);
                    var ln_size = parseInt(correos.length);

                    var i = 0;

                    for (i; ln_size > i; i++) {
                        var correo = correos[i];
                        var ld_i = gd_correosContainer.find("#Correo_" + i).children().find("i");

                        ld_i.removeClass();

                        if (parseInt(correo['status']) < 0)
                        {
                            ld_i.addClass("fa fa-times-circle");
                            ld_i.css("color", "rgba(255,0,0,0.60)");
                        }
                        else
                        {
                            ld_i.addClass("fa fa-check-circle");
                            ld_i.css("color", "#4CAF50");
                        }
                    }
                    gd_enviarCorreosContent.show(500);
                    gd_cubitoWaiting.hide(500);
                });
            }

            $("#i_btnCancelarFactura").click(function () {
                $("#i_modalCancelarFactura").modal("show");
            });


            function closeAlert()
            {
                $(".alert").hide();
            }

            $("#i_modalEnviarCorreo").on('hidden.bs.modal', function () {

                $("#i_alertMailParams").hide();

            });


            function ValidateEmail(mail) {

                if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)) {

                    return true;

                }

                return false;

            }
            function isEmailRepeated(mail)
            {

                for (var value of gm_correos.keys())
                {

                    if (value == mail) { return true;}

                }

                return false;

            }


            function update_mailTable()
            {
                var buf = [];
                var ln_index = parseInt(ga_correosOrder2Mail.length) - 1; //Último id comprobado
                var ls_html = gd_tableCorreos.html().trim();

                if (ls_html === "") {

                    for (ln_index; ln_index > -1; ln_index--) {

                        var correo = ga_correosOrder2Mail[ln_index];

                        if (correo !== undefined)

                            buf.push('<tr id="Correo_' + ln_index + '"><td style="color:white">' + correo + '<td><button onclick=\"eliminar_correoAgregado(\'' + correo + '\')\"  type="button" class="btn btn-default c_Cancel"><i class="fa fa-trash" style = "font-size:20px" aria-hidden="true"></i></button><button style = "margin-left: 6%;" onclick="open_modalCorreo(\'' + correo + '\')" type="button" class="btn btn-default c_Accept"><i class="fa fa-envelope-o" style = "font-size:20px;"aria-hidden="true"></i></button></td></tr>');

                    }
                    gd_tableCorreos.html(buf.join(""));

                }
                else {

                    var correo = ga_correosOrder2Mail[ln_index];

                    gd_tableCorreos.prepend('<tr id="Correo_' + ln_index + '"><td style="color:white">' + correo + '<td><button onclick=\"eliminar_correoAgregado(\'' + correo + '\')\"  type="button" class="btn btn-default c_Cancel"><i class="fa fa-trash" style = "font-size:20px;" aria-hidden="true"></i></button><button style = "margin-left: 6%;" onclick="open_modalCorreo(\'' + correo + '\')" type="button" class="btn btn-default c_Accept"><i class="fa fa-envelope-o" style = "font-size:20px;" aria-hidden="true"></i></button></td></tr>');

                }
            }

            function open_modalCorreo(mail)
            {
                mail = mail.trim();
                var mail_params = gm_correos.get(mail);
                $("#i_inputAsunto").val(mail_params.asunto);

                $("#i_inputCorreoMsg").val(mail_params.cuerpo);



                $("#i_btnAceptarPlantillaMail").val(mail);

                $("#i_modalEnviarCorreo").modal();

            }
            $("#i_btnAceptarPlantillaMail").click(function () {
                ld_asunto = $("#i_inputAsunto");

                ld_cuerpo = $("#i_inputCorreoMsg");

                var mail = $(this).val();

                var asunto =ld_asunto.val();
                var cuerpo = ld_cuerpo.val();
                if (asunto.trim() == '' || cuerpo.trim() == '') { $("#i_modalCamposVacios").modal("show"); }
                else {
                    gm_correos.set(mail, { asunto: asunto, cuerpo: cuerpo });
                    gd_modalAgregarAsuntoCuerpo.modal("hide");
                }

            });

            function eliminar_correoAgregado(mail)
            {
                mail = mail.trim();
                var order = gm_correosMail2Order.get(mail);
                var mail = ga_correosOrder2Mail[order];

                gm_correos.delete(mail);
                gm_correosMail2Order.delete(mail);
                delete ga_correosOrder2Mail[order];

                if (gm_correos.size === 0)
                    ga_correosOrder2Mail = [];

                //'<tr id="Correo_' + ln_index + '"><td style="color:white">' + correo + '<td><button onclick=\"eliminar_correoAgregado(\'' + correo + '\')\"  type="button" id="i_estadoTimbrePillDeshacer" class="btn btn-primary"><i class="fa fa-trash" aria-hidden="true"></i></button><button style = "margin-left: 6%;" onclick="open_modalCorreo(\'' + correo + '\')" type="button" id="i_estadoTimbrePillGuardadas" class="btn btn-default"><i class="fa fa-envelope-o" aria-hidden="true"></i></button></td></tr>'
                var ld_tr = $("#Correo_" + order).remove();
            }

            $("#i_btnAgregarCorreo").click(function () {
                var mail = gd_inputCorreo.val();
                if(ValidateEmail(mail) && !isEmailRepeated(mail))
                {
                    var ln_jerarquicOrder = ga_correosOrder2Mail.length;
                    gm_correos.set(mail, "");
                    gm_correosMail2Order.set(mail, ln_jerarquicOrder);
                    ga_correosOrder2Mail[ln_jerarquicOrder] = mail;
                    update_mailTable();
                }
                else
                {
                    $("#i_modalCorreoInvalido").modal("show");
                }

            });

            // para mostrar alerts nuevamente basta con hacer $("#idAlert").show()
            $(".close").click(function () {
                if ($(this).val() == "v_alertSuc") { $("#i_alertSuccess").hide();}
                if ($(this).val() == "v_alertDang") { $("#i_alertDanger").hide(); }
            });
    </script>
    
</body>
</html> 